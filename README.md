# 日本語メモアプリ（改善版）

Fastifyで構築された美しく直感的なメモアプリケーションです。ユーザーが日本語でメモを作成、整理、管理できます。このアプリケーションは、クリーンでモダンなインターフェースと完全なCRUD操作、永続的なJSONベースのストレージを特徴とし、個人的なメモ取り、日記、思考やアイデアの整理に最適です。

**🆕 最新の改善**: セキュリティ強化、高度なエラーハンドリング、パフォーマンス最適化、環境変数サポートを追加しました。

## 📌 このアプリケーションについて

このアプリケーションは、Node.jsとFastifyフレームワークを使って作られた、シンプルで使いやすいメモ管理ツールです。プログラミング初心者の方でも理解しやすいように、以下の特徴があります：

- **単一ファイル構成**: すべてのコードが`index.js`という1つのファイルにまとまっています
- **データベース不要**: 複雑なデータベースの代わりに、シンプルなJSONファイルを使用
- **日本語完全対応**: インターフェースもデータも、すべて日本語で扱えます
- **モダンなデザイン**: 美しいグラデーションとアニメーションで見た目も楽しく
- **セキュリティ対策済み**: XSS攻撃から保護し、入力検証も実装

## ✨ 主な機能

### 基本機能
- **📝 完全なCRUD操作**: 
  - **C**reate（作成）: 新しいメモを追加
  - **R**ead（読み取り）: 保存されたメモを表示
  - **U**pdate（更新）: 既存のメモを編集
  - **D**elete（削除）: 不要なメモを削除
- **📋 タイトル・内容構造**: 説明的なタイトルと詳細な内容でメモを整理
- **🇯🇵 日本語サポート**: UTF-8エンコーディングと日本語フォントレンダリングを最適化
- **💾 永続的ストレージ**: データは自動的にJSON形式で保存され、セッション間で永続化

### ユーザーインターフェース機能
- **🎨 美しいUI**: スムーズなアニメーションとトランジションを持つモダンなグラデーションベースのデザイン
- **📱 レスポンシブデザイン**: デスクトップ、タブレット、モバイルデバイスでシームレスに動作
- **⚡ リアルタイム更新**: メモの作成、編集、削除後に即座にUI更新
- **🔍 インライン編集**: 別ページに移動することなく、インターフェース内で直接メモを編集
- **📊 フィードバック**: 操作結果を示すエラー/成功メッセージ表示
- **⏳ ローディング状態**: 処理中の視覚的フィードバック

### 技術的機能
- **📊 メモ統計**: 総メモ数と作成・更新タイムスタンプを表示
- **🚀 RESTful API**: プログラムアクセスと統合のためのクリーンなAPIエンドポイント
- **🔒 セキュリティ**: XSS対策、入力検証、エラーハンドリング
- **⚡ パフォーマンス**: オプションのメモリキャッシュ、効率的なID管理
- **🔧 設定可能**: 環境変数による柔軟な設定

## 🆕 改善された機能

### セキュリティ強化
- **XSS対策**: すべてのユーザー入力をHTMLエスケープ
- **入力検証**: JSON Schemaによる厳格なバリデーション
- **文字数制限**: タイトル200文字、内容5000文字まで
- **HTMLタグ拒否**: タイトルに基本的なHTMLタグを許可しない

### エラーハンドリング
- **グローバルエラーハンドラー**: 一元的なエラー処理
- **詳細なエラーメッセージ**: ユーザーフレンドリーなエラー表示
- **プロセスレベルの保護**: 未処理の例外を適切に処理
- **優雅なシャットダウン**: SIGTERMシグナルの処理

### パフォーマンス最適化
- **メモリキャッシュ**: 読み込み操作の高速化（設定可能）
- **効率的なID管理**: O(1)のID生成
- **静的ファイルキャッシュ**: 本番環境で7日間のキャッシュ
- **環境別の最適化**: 開発/本番環境に応じた設定

## 🚀 インストール

### 前提条件

システムに以下がインストールされていることを確認してください：

#### Node.js（必須）
- **バージョン**: 16.0以上
- **確認方法**: ターミナル（コマンドプロンプト）で以下を実行
  ```bash
  node --version
  ```
  `v16.0.0`以上が表示されればOK
- **インストール方法**: [Node.js公式サイト](https://nodejs.org/)からダウンロード

#### npm（必須）
- **説明**: Node.jsのパッケージマネージャー（通常Node.jsに付属）
- **確認方法**: 
  ```bash
  npm --version
  ```
- **役割**: アプリケーションが必要とする外部ライブラリ（Fastifyなど）をインストール

#### モダンなWebブラウザ（必須）
- Chrome、Firefox、Safari、Edgeのいずれか
- JavaScript対応が必要

### ステップバイステップインストール

#### 1. **プロジェクトをクローンまたはダウンロード**:

**Gitを使う場合**（Gitがインストールされている場合）:
```bash
git clone <your-repository-url>
cd Fastify_Japanese_Web_Application
```

**Gitを使わない場合**:
- GitHubのページから「Code」→「Download ZIP」をクリック
- ダウンロードしたZIPファイルを解凍
- ターミナルで解凍したフォルダに移動：
  ```bash
  cd ダウンロードしたフォルダのパス
  ```

#### 2. **依存関係をインストール**:

このコマンドで、アプリケーションが必要とするすべてのライブラリが自動的にインストールされます：
```bash
npm install
```

**何が起きるか**:
- `package.json`ファイルを読み込み
- 必要なライブラリ（Fastifyと@fastify/static）をダウンロード
- `node_modules`フォルダに保存

#### 3. **インストールを確認**:

正しくインストールされたか確認：
```bash
npm list
```

以下のような表示が出れば成功：
```
japanese-memo-app
├── @fastify/static@6.12.0
└── fastify@4.24.3
```

#### 4. **アプリケーションを起動**:

開発モードで起動（推奨）：
```bash
npm run dev
```

**起動成功時の表示**:
```
🚀 日本語メモアプリが http://localhost:3000 で起動しました
環境: 開発
キャッシュ: 有効
```

#### 5. **アプリケーションにアクセス**:

ブラウザを開き、アドレスバーに以下を入力：
```
http://localhost:3000
```

## 📖 使用方法ガイド

### アプリケーションの起動

#### 開発モードで起動（推奨）
```bash
# 基本的な開発モード
npm run dev

# 詳細なログを表示
NODE_ENV=development LOG_LEVEL=debug npm run dev

# ポートを変更して起動
PORT=8080 npm run dev
```

- **利点**: エラーメッセージが詳しく表示される、読みやすいログ形式
- **用途**: 開発中やテスト時

#### 本番モードで起動
```bash
# 基本的な本番モード
npm start

# キャッシュとバックアップを有効化
NODE_ENV=production CACHE_ENABLED=true BACKUP_ENABLED=true npm start
```

- **利点**: パフォーマンスが最適化される、セキュリティが強化される
- **用途**: 実際の運用時

### Webインターフェース操作

#### ✍️ 新しいメモの作成

1. **メインページに移動**
   - ブラウザで `http://localhost:3000` を開く

2. **「新しいメモを作成」フォームに入力**:
   - **タイトル**: メモの要約や見出し（最大200文字）
   - **内容**: メモの詳細内容（最大5000文字）

3. **「💾 メモを保存」をクリック**
   - 成功メッセージが表示される
   - メモが一覧に追加される

#### 📖 メモの表示

すべてのメモは「📋 メモ一覧」セクションに表示されます。各メモには以下の情報が含まれます：

- **タイトル**: メモの見出し（HTMLエスケープ済み）
- **内容**: メモの本文（改行対応、HTMLエスケープ済み）
- **作成日時**: メモを最初に作成した日時
- **最終更新日時**: 最後に編集した日時（作成後に編集した場合のみ表示）
- **アクションボタン**: 
  - ✏️ 編集: メモの内容を変更
  - 🗑️ 削除: メモを完全に削除

#### ✏️ メモの編集

1. **編集したいメモを見つける**
2. **「✏️ 編集」ボタンをクリック**
3. **編集フォームでタイトルや内容を修正**
4. **保存または取り消し**:
   - 「💾 更新」: 変更を保存
   - 「❌ キャンセル」: 変更を破棄

#### 🗑️ メモの削除

1. **削除したいメモを見つける**
2. **「🗑️ 削除」ボタンをクリック**
3. **確認ダイアログで「OK」をクリック**
4. **メモが完全に削除される**

### APIエンドポイント（上級者向け）

アプリケーションはプログラムアクセス用のRESTful APIを提供します。すべてのエンドポイントは入力検証付きです。

#### 📋 全メモ取得

**リクエスト**:
```bash
curl -X GET http://localhost:3000/api/memos
```

**レスポンス例**:
```json
[
  {
    "id": 1,
    "title": "買い物リスト",
    "content": "牛乳、パン、卵を買う",
    "createdAt": "2025-01-02T12:00:00.000Z",
    "updatedAt": "2025-01-02T12:00:00.000Z"
  }
]
```

#### ✍️ 新しいメモの作成

**リクエスト**:
```bash
curl -X POST http://localhost:3000/api/memos \
  -H "Content-Type: application/json" \
  -d '{
    "title": "新しいメモ",
    "content": "メモの内容をここに書きます"
  }'
```

**バリデーションルール**:
- `title`: 必須、1-200文字、HTMLタグ不可
- `content`: 必須、1-5000文字

#### ✏️ メモの更新

**リクエスト**:
```bash
curl -X PUT http://localhost:3000/api/memos/1 \
  -H "Content-Type: application/json" \
  -d '{
    "title": "更新されたタイトル",
    "content": "更新された内容"
  }'
```

#### 🗑️ メモの削除

**リクエスト**:
```bash
curl -X DELETE http://localhost:3000/api/memos/1
```

## 📁 プロジェクト構造

```
Fastify_Japanese_Web_Application/
├── index.js          # メインFastifyサーバーアプリケーション（改善版）
├── package.json      # プロジェクトの依存関係とスクリプト
├── package-lock.json # 依存関係の正確なバージョンを記録
├── data.json         # メモデータ永続化用JSONファイル（自動生成）
├── data.json.backup  # データのバックアップ（BACKUP_ENABLED=true時）
├── README.md         # このドキュメントファイル
├── CLAUDE.md         # Claude Code用のガイダンス
├── public/           # 静的ファイル用ディレクトリ（将来使用予定）
│   ├── css/         # CSSファイル用
│   └── js/          # JavaScriptファイル用
└── node_modules/     # インストールされた外部ライブラリ（自動生成）
```

### 各ファイルの説明

- **index.js**: アプリケーションのすべてのコードが含まれるメインファイル（セキュリティ強化版）
- **package.json**: プロジェクトの設定ファイル（名前、バージョン、依存関係など）
- **package-lock.json**: 依存関係の正確なバージョンを固定（チーム開発で重要）
- **data.json**: メモのデータが保存されるファイル（自動生成）
- **CLAUDE.md**: 開発者向けのアーキテクチャドキュメント
- **node_modules/**: npmでインストールしたライブラリが保存されるフォルダ

## ⚙️ 設定

### 環境変数による設定

アプリケーションは環境変数で以下の設定をカスタマイズできます：

| 環境変数 | 説明 | デフォルト値 | 例 |
|---------|------|------------|-----|
| `PORT` | サーバーのポート番号 | `3000` | `PORT=8080` |
| `HOST` | サーバーのホスト | `0.0.0.0` | `HOST=localhost` |
| `NODE_ENV` | 実行環境 | `production` | `NODE_ENV=development` |
| `LOG_LEVEL` | ログレベル | `info` | `LOG_LEVEL=debug` |
| `DATA_FILE` | データファイルのパス | `./data.json` | `DATA_FILE=/var/data/memos.json` |
| `CACHE_ENABLED` | キャッシュの有効/無効 | `true` | `CACHE_ENABLED=false` |
| `CACHE_DURATION` | キャッシュ保持時間（ミリ秒） | `5000` | `CACHE_DURATION=10000` |
| `BACKUP_ENABLED` | バックアップの有効/無効 | `false` | `BACKUP_ENABLED=true` |

#### 環境変数の設定方法

**Linux/Mac:**
```bash
# 一時的に設定
PORT=8080 npm start

# または環境変数をエクスポート
export PORT=8080
export NODE_ENV=development
npm start
```

**Windows (コマンドプロンプト):**
```cmd
set PORT=8080
set NODE_ENV=development
npm start
```

**Windows (PowerShell):**
```powershell
$env:PORT="8080"
$env:NODE_ENV="development"
npm start
```

**.envファイルを使用する場合（dotenvパッケージが必要）:**
```bash
# .envファイルを作成
echo "PORT=8080" >> .env
echo "NODE_ENV=development" >> .env
echo "BACKUP_ENABLED=true" >> .env
```

### 設定例

#### 開発環境の推奨設定
```bash
NODE_ENV=development \
LOG_LEVEL=debug \
CACHE_ENABLED=false \
npm run dev
```

#### 本番環境の推奨設定
```bash
NODE_ENV=production \
LOG_LEVEL=warn \
CACHE_ENABLED=true \
CACHE_DURATION=10000 \
BACKUP_ENABLED=true \
npm start
```

## 🎨 詳細機能

### セキュリティ機能

#### XSS対策
- **HTMLエスケープ**: すべてのユーザー入力を自動的にエスケープ
- **特殊文字の処理**: `<`, `>`, `"`, `'`, `&`を安全な文字に変換
- **スクリプト実行防止**: 悪意のあるJavaScriptの実行を防ぐ

#### 入力検証
- **JSON Schema**: 厳格な型チェックと制約
- **文字数制限**: タイトル200文字、内容5000文字
- **パターンマッチング**: タイトルでのHTMLタグ使用を制限
- **必須フィールド**: タイトルと内容の両方が必須

### パフォーマンス機能

#### メモリキャッシュ
- **高速読み込み**: ファイルアクセスを削減
- **自動更新**: 書き込み時に自動的にキャッシュをクリア
- **設定可能**: `CACHE_ENABLED`と`CACHE_DURATION`で制御

#### 効率的なID管理
- **O(1)のID生成**: 配列スキャンを回避
- **連番管理**: 削除されたIDは再利用しない
- **初期化の最適化**: 起動時に一度だけ最大IDを計算

### エラーハンドリング

#### ユーザーフレンドリーなエラー
- **日本語メッセージ**: すべてのエラーメッセージが日本語
- **詳細度の制御**: 開発環境では詳細、本番環境では簡潔
- **視覚的フィードバック**: エラー/成功メッセージの表示

#### システムレベルの保護
- **グローバルエラーハンドラー**: 未処理のエラーをキャッチ
- **プロセス保護**: 未処理の例外でもアプリがクラッシュしない
- **優雅なシャットダウン**: 終了時にリソースを適切に解放

### 開発者向け機能

- **構造化ログ**: JSON形式でのログ出力オプション
- **デバッグモード**: 詳細なエラー情報とスタックトレース
- **RESTful API**: 標準的なHTTPメソッドとステータスコード
- **バリデーションエラー詳細**: 開発時は具体的な検証エラーを表示

## 🔧 トラブルシューティング

### よくある問題と解決方法

#### 1. **ポートが既に使用中**

**エラーメッセージ**:
```
Error: listen EADDRINUSE: address already in use :::3000
```

**原因**: 他のアプリケーションがポート3000を使用している

**解決方法A - 競合するプロセスを停止**:
```bash
# Windows (PowerShell)
netstat -ano | findstr :3000
taskkill /PID プロセスID /F

# Mac/Linux
lsof -ti:3000 | xargs kill -9
```

**解決方法B - 別のポートを使用**:
```bash
PORT=8080 npm start
```

#### 2. **データファイルの破損**

**症状**: アプリが起動しない、メモが表示されない

**解決方法**:
```bash
# データファイルをバックアップ（念のため）
cp data.json data.json.backup

# データファイルを削除
rm data.json

# アプリを再起動（新しい空のデータファイルが作成される）
npm start
```

#### 3. **モジュールインストールの問題**

**エラーメッセージ**: 
```
Cannot find module 'fastify'
```

**解決方法**:
```bash
# node_modulesとpackage-lock.jsonを削除
rm -rf node_modules package-lock.json

# 再インストール
npm install
```

#### 4. **日本語テキスト表示の問題**

**症状**: 日本語が文字化けする、□や？で表示される

**確認事項**:
1. ブラウザの文字エンコーディングがUTF-8に設定されているか
2. システムに日本語フォントがインストールされているか
3. `data.json`ファイルがUTF-8で保存されているか

**解決方法**:
- ブラウザの設定で文字エンコーディングをUTF-8に
- 日本語フォント（メイリオ、ヒラギノ等）をインストール

#### 5. **キャッシュの問題**

**症状**: 新しいメモが表示されない、古いデータが表示される

**解決方法**:
```bash
# キャッシュを無効にして起動
CACHE_ENABLED=false npm start

# またはキャッシュ時間を短くする
CACHE_DURATION=1000 npm start
```

## 🔮 今後の拡張予定

将来のバージョンで実装を検討している機能：

### 検索・整理機能
- 🔍 **検索・フィルター機能**: キーワードでメモを検索
- 🏷️ **タグとカテゴリ**: メモを分類して整理
- 📅 **日付フィルター**: 作成日・更新日で絞り込み

### エクスポート・共有機能
- 📤 **メモエクスポート**: PDF、TXT、Markdown形式でダウンロード
- 📧 **メール送信**: メモを直接メールで共有
- 🔗 **共有リンク**: 特定のメモへの一時的なアクセスリンク

### セキュリティ・マルチユーザー
- 🔐 **ユーザー認証**: ログイン機能でプライベートメモ
- 👥 **マルチユーザー対応**: 複数人での利用
- 🔑 **暗号化**: メモデータの暗号化保存

### モバイル・クラウド対応
- 📱 **モバイルアプリ版**: iOS/Android専用アプリ
- ☁️ **クラウド同期**: 複数デバイス間でメモを同期
- 💾 **自動バックアップ**: クラウドストレージへの定期バックアップ

### その他の機能
- 🎨 **リッチテキストエディタ**: 文字装飾、画像挿入
- 📊 **統計・分析**: メモの利用状況を可視化
- 🔔 **リマインダー**: 特定の日時に通知
- 🌐 **多言語対応**: 英語、中国語、韓国語など
- ♿ **アクセシビリティ**: スクリーンリーダー対応
- 🧪 **テスト**: 単体テスト・統合テストの追加

## 📝 ライセンス

このプロジェクトはオープンソースで、[MIT License](LICENSE)の下で利用可能です。

**MITライセンスとは**:
- 自由に使用、コピー、改変、配布が可能
- 商用利用も可能
- ただし著作権表示とライセンス表示は必要

## 🤝 貢献

このプロジェクトへの貢献を歓迎します！

### 貢献の方法
1. **バグ報告**: GitHubのIssuesで報告
2. **機能提案**: 新しいアイデアをIssuesで提案
3. **コード貢献**: Pull Requestを送信

### コーディング規約
- **コメント**: 日本語で分かりやすく
- **変数名**: 意味の分かる名前を使用
- **エラー処理**: 適切なエラーメッセージを提供
- **テスト**: 新機能には可能な限りテストを追加

### 初心者の方へ
- 小さな修正（誤字脱字など）から始めてOK
- 分からないことは気軽に質問してください
- 日本語でのやり取りも歓迎です

---

**メモを楽しんでください！Happy note-taking!** 📝✨

### サポート

問題が解決しない場合や質問がある場合は、GitHubのIssuesで報告してください。日本語での質問も歓迎です。

### 謝辞

このプロジェクトは以下の素晴らしいオープンソースプロジェクトを使用しています：
- [Fastify](https://www.fastify.io/) - 高速で低オーバーヘッドなWebフレームワーク
- [Node.js](https://nodejs.org/) - JavaScriptランタイム